<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tap&Go</title>
    <link rel="icon" href="logounico2.png" type="image/x-icon" sizes="16x16">
    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            font-family: Arial, sans-serif;
        }
        .header {
            text-align: center;
            padding: 2vh 0;
            background-color: #1d0ea3;
            color: white;
            font-size: 24px;
        }
        .content {
            display: flex;
            flex: 1;
        }
        .left-section {
            width: 25%;
            background-color: #ffffff;
            padding: 2vh;
            box-sizing: border-box;
        }
        .left-section img {
            display: block;
            max-width: 100%;
            height: auto;
            object-fit: contain;
        }
        .left-section button {
            margin-top: 2vh;
            padding: 1vh 2vh;
            font-size: 2vh;
            cursor: pointer;
        }
        .right-section {
            width: 75%;
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2vh;
            box-sizing: border-box;
            font-size: 2.5vh;
        }
        .router-section {
            display: none;
            flex-direction: column; /* Disporre gli elementi in colonna */
            align-items: flex-start;    /* Allinea gli elementi a sinistra */
            width: 75vw;    
            background-color: #c0c0c0;
            padding: 2vh;
            box-sizing: border-box;
        }
        .h-router-section {
            margin: 0; /* Remove default margins */
            padding: 2vh 0vh; /* Add some space below the title */
            font-size: 3vh; /* Adjust the font size if necessary */
            font-weight: bold; /* Make the text bold */
            text-align: center; /* Center the text */
            width: 100%; /* Take full width to ensure centering */
        }
        .p-router-section {
            margin: 1vh;
        }
        .router-section-button {
            margin: 1vh;
            padding: 1vh 2vh;
            font-size: 2vh;
            cursor: pointer;
            display: inline-block;
        }
        .status-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: gray; /* Colore predefinito (stato sconosciuto) */
            margin-right: 10px;
            display: inline-block;
        }
        .status-text {
            display: inline-block;
        }
        .status-time {
            font-size: 1.5vh;
            color: #555555;
        }
        .back-button {
            position: absolute;
            bottom: 2vh;
            right: 2vh;
        }
        .logout-button {
            position: absolute;
            top: 2vh;
            right: 2vh;
            padding: 0.5vh 1vh;
            font-size: 1.5vh;
            cursor: pointer;
            background-color: #e0e0e0;
            border: none;
            border-radius: 5px;
            color: #1d0ea3;
        }
    </style>
    <script>
        let intervalId = null;  // Variabile per tenere traccia dell'intervallo

         // Verifica se l'utente è autenticato
         function checkAuth() {
            console.log('Controllo delle credenziali in corso...');
            console.log('Valore salvato in localStorage:', localStorage.getItem('authenticated'));
            if (localStorage.getItem('authenticated') !== 'true') {
                console.log(localStorage.getItem('authenticated'));
                console.log('Controllo credenziali fallito');
                window.location.href = 'login.html';
            }
        }
        
        window.onload = function() {
            checkAuth();
        }; // Chiama checkAuth al caricamento della pagina
        
        //FUNZIONE PER VISUALIZZARE LA SEZIONE DEL ROUTER_1 PER IL BOTTONE Router1
        function showRouter1Section() {
            document.querySelector('.right-section').style.display = 'none';
            document.querySelector('.router-section').style.display = 'flex';
            checkRouterStatus('192.168.1.1'); // Controlla immediatamente lo stato del router
            startRouterStatusCheck(); // Avvia il controllo dello stato del router
        }
        //FUNZIONE PER VISUALIZZARE LA PAGINA INIZIALE PER IL BOTTONE Torna alla Home Page
        function showRightSection() {
            document.querySelector('.router-section').style.display = 'none';
            document.querySelector('.right-section').style.display = 'flex';
            stopRouterStatusCheck(); // Ferma il controllo dello stato del router
        }
        // FUNZIONE PER VISUALIZZARE LO STATO DEL ROUTER tramite il Server Backend
        async function checkRouterStatus(routerIp) {

            try {
                const response = await fetch(`http://localhost:3000/check-router?routerIp=${routerIp}`);
                const statusCircle = document.getElementById('status-circle');
                const statusText = document.getElementById('connection-status');
                const statusTime = document.getElementById('status-time');
                const data = await response.json();

                console.log(data.connected);

                if (data.connected) {
                    statusCircle.style.backgroundColor = 'green'; // Verde se connesso
                    statusText.textContent = 'Il router è acceso e funzionante.';
                } else {
                    statusCircle.style.backgroundColor = 'red'; // Verde se connesso
                    statusText.textContent = 'Il router non è raggiungibile.';
                }

                // Mostra l'orario dell'ultimo controllo
                const now = new Date();
                const timeString = now.toLocaleTimeString(); // Ottieni l'orario locale in formato leggibile
                statusTime.textContent = `Ultimo controllo: ${timeString}`;

            } catch (error) {
                const statusCircle = document.getElementById('status-circle');
                const statusText = document.getElementById('connection-status');
                const statusTime = document.getElementById('status-time');

                statusCircle.style.backgroundColor = 'gray'; // Grigio se errore
                console.error('Errore nella richiesta:', error);
                statusText.textContent = 'Errore di connessione al server.';
                // Mostra l'orario dell'ultimo controllo
                const now = new Date();
                const timeString = now.toLocaleTimeString(); // Ottieni l'orario locale in formato leggibile
                statusTime.textContent = `Ultimo controllo: ${timeString}`;
            }
        }
        /* document.getElementById('checkRouter').addEventListener('click', async () => {
            const routerIp = '192.168.1.1'; // Sostituisci con l'IP del tuo router
            try {
                const response = await fetch(`http://${routerIp}/`, {
                    method: 'GET',
                    mode: 'no-cors' // Questo evita problemi di CORS, ma limita l'accesso alla risposta
                });
                
                if (response.ok) {
                    document.getElementById('status').textContent = "Il router è attivo e funzionante.";
                } else {
                    document.getElementById('status').textContent = "Il router non ha risposto come previsto.";
                }
            } catch (error) {
                document.getElementById('status').textContent = "Errore nella connessione al router.";
                console.error("Errore:", error);
            }
        });
        */ 
        // Funzione per avviare il controllo dello stato del router ogni 3 minuti
        function startRouterStatusCheck() {
            if (intervalId) return; // Evita di avviare più intervalli
            intervalId = setInterval(() => checkRouterStatus('192.168.1.1'), 3 * 60 * 1000); // 3 minuti
        }

        // Funzione per fermare il controllo dello stato del router
        function stopRouterStatusCheck() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
        }

        // Funzione per gestire la richiesta dei dati GPS al server Node.js
        function getGPSdata() {
            // Fai una richiesta al server Node.js
            fetch('http://localhost:3000/get-gps')
                .then(response => response.json())
                .then(data => {
                    if (data.latitude && data.longitude) {
                        document.getElementById('gpsResult').textContent = 
                            `Latitudine: ${data.latitude}, Longitudine: ${data.longitude}`;
                    } else {
                        document.getElementById('gpsResult').textContent = 'Nessun dato GPS disponibile';
                    }
                })
                .catch(error => {
                    console.error('Errore nella richiesta:', error);
                    document.getElementById('gpsResult').textContent = 'Errore nella richiesta';
                });
        }



        function logout() {
            localStorage.removeItem('authenticated');
            window.location.href = 'login.html';
        }

        //Controllo Protocollo - Dominio - Porta 
        console.log('Protocollo:', window.location.protocol);
        console.log('Dominio:', window.location.hostname);
        console.log('Porta:', window.location.port);

    </script>
</head>

<body>
    <div class="header">
        Tap&Go: Admin Panel

    </div>
    <div class="content">
        <div class="left-section">
            <img src="logounico.png" Style="width: 250px; height: 120px;" >
            <button onclick="showRouter1Section()"> Router 1 </button>
        </div>
        <div class="right-section">
            <p>Aggiungere specifiche del sito e quali saranno le funzionalità disponibili</p>
            <button class="logout-button" onclick="logout()">Logout</button>

        </div>

        <div class="router-section">
            <p class="h-router-section">Sezione Router 1</p>

            <div class="status-section">
                <span class="status-circle" id="status-circle"></span>
                <span class="status-text" id="connection-status">Stato Connessione:</span>
                <span class="status-time" id="status-time">Ultimo controllo: -</span>
            </div>
            <button class="router-section-button" onclick="checkRouterStatus('192.168.1.1')">RouterCheck</button>
            <p></p>
            <div class="status-section"
            <p class="p-router-section"> Controllo dati GPS</p>
            <button class="router-section-button" onclick="getGPSdata()">Funzionalità 2</button>
            <p id="gpsData">Dati GPS: <span id="gpsResult">Nessun dato disponibile</span></p>
            </div>
        

            <button class="router-section-button">Funzionalità 3</button>

            <button class="back-button" onclick="showRightSection()">Torna alla Home Page</button>
            <button class="logout-button" onclick="logout()">Logout</button>
        </div>
    </div>
</body>
</html>
